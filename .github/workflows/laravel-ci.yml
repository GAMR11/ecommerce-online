name: Laravel CI/CD with DORA Metrics & Railway Deploy

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

env:
  PHP_VERSION: '8.2'

jobs:
  # ============================================
  # JOB 1: TESTS
  # ============================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: testing
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql
          coverage: none

      - name: Cache Composer dependencies
        uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Install dependencies
        run: composer install --no-interaction --prefer-dist --optimize-autoloader

      - name: Prepare Laravel
        run: |
          cp .env.example .env
          php artisan key:generate
          chmod -R 777 storage bootstrap/cache

      - name: Run migrations
        env:
          DB_CONNECTION: mysql
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_DATABASE: testing
          DB_USERNAME: root
          DB_PASSWORD: password
        run: php artisan migrate --force

      - name: Execute tests
        env:
          DB_CONNECTION: mysql
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_DATABASE: testing
          DB_USERNAME: root
          DB_PASSWORD: password
        run: php artisan test

  # ============================================
  # JOB 2: DEPLOY TO RAILWAY & TRACK DORA METRICS
  # ============================================
  deploy:
    name: Deploy to Railway & Track DORA Metrics
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ============================================
      # CAPTURA DE TIMESTAMP INICIAL (para Lead Time real)
      # ============================================
      - name: ðŸ“Š Capture Deploy Start Time
        id: deploy_start
        run: |
          echo "DEPLOY_START_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT
          echo "DEPLOY_START_EPOCH=$(date +%s)" >> $GITHUB_OUTPUT
          echo "ðŸ• Deploy started at: $(date -u +%Y-%m-%dT%H:%M:%SZ)"

      # ============================================
      # DEPLOY A RAILWAY (sin sleeps artificiales)
      # ============================================
      - name: ðŸš€ Trigger Railway Deployment
        id: railway_deploy
        run: |
          echo "ðŸš€ Railway auto-deploys on push to master"
          echo "ðŸ“¦ Branch: ${{ github.ref_name }}"
          echo "ðŸ“ Commit: ${{ github.sha }}"
          echo "â³ Railway will deploy automatically..."

          # Railway ya estÃ¡ desplegando en paralelo gracias al webhook de GitHub
          # No agregamos sleeps para no alterar las mÃ©tricas

      # ============================================
      # VERIFICACIÃ“N DE DEPLOYMENT CON RETRY INTELIGENTE
      # (sin alterar el tiempo de deploy, solo verifica disponibilidad)
      # ============================================
      - name: âœ… Wait for Railway Deployment
        id: verify_deploy
        run: |
          echo "ðŸ” Waiting for Railway deployment to be ready..."

          MAX_ATTEMPTS=30
          ATTEMPT=0
          WAIT_SECONDS=5

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.APP_URL }}/api/ping || echo "000")

            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… Railway deployment is live! (HTTP 200)"
              echo "DEPLOY_SUCCESS=true" >> $GITHUB_OUTPUT
              exit 0
            fi

            ATTEMPT=$((ATTEMPT + 1))
            echo "â³ Attempt $ATTEMPT/$MAX_ATTEMPTS - HTTP $HTTP_CODE - Retrying in ${WAIT_SECONDS}s..."

            if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
              sleep $WAIT_SECONDS
            fi
          done

          echo "âŒ Deployment verification failed after $MAX_ATTEMPTS attempts"
          echo "DEPLOY_SUCCESS=false" >> $GITHUB_OUTPUT
          exit 1

      # ============================================
      # CAPTURA DE TIMESTAMP FINAL (Deploy completado)
      # ============================================
      - name: ðŸ“Š Capture Deploy End Time
        id: deploy_end
        if: success()
        run: |
          echo "DEPLOY_END_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT
          echo "DEPLOY_END_EPOCH=$(date +%s)" >> $GITHUB_OUTPUT
          echo "âœ… Deploy completed at: $(date -u +%Y-%m-%dT%H:%M:%SZ)"

      # ============================================
      # MÃ‰TRICA DORA 1: DEPLOYMENT FREQUENCY
      # ============================================
      - name: ðŸ“Š Record Deployment (Deployment Frequency)
        if: success()
        run: |
          curl -X POST ${{ secrets.APP_URL }}/api/metrics/deployment \
            -H "Content-Type: application/json" \
            -H "X-API-Key: ${{ secrets.METRICS_API_KEY }}" \
            -d '{
              "tool": "github-actions",
              "timestamp": "${{ steps.deploy_end.outputs.DEPLOY_END_TIME }}",
              "branch": "${{ github.ref_name }}",
              "commit": "${{ github.sha }}",
              "status": "success"
            }' && echo "âœ… Deployment frequency recorded"

      # ============================================
      # MÃ‰TRICA DORA 2: LEAD TIME FOR CHANGES (REAL)
      # ============================================
      - name: ðŸ“Š Calculate & Record Real Lead Time
        if: success()
        run: |
          # Obtener tiempo del commit (cuando se hizo el cÃ³digo)
          COMMIT_TIME=$(git show -s --format=%cI ${{ github.sha }})
          COMMIT_EPOCH=$(date -d "$COMMIT_TIME" +%s)

          # Tiempo de deploy real (cuando Railway terminÃ³ de desplegar)
          DEPLOY_TIME="${{ steps.deploy_end.outputs.DEPLOY_END_TIME }}"
          DEPLOY_EPOCH=${{ steps.deploy_end.outputs.DEPLOY_END_EPOCH }}

          # Calcular Lead Time REAL (desde commit hasta deploy completo)
          LEAD_TIME=$((DEPLOY_EPOCH - COMMIT_EPOCH))
          LEAD_TIME_MINUTES=$((LEAD_TIME / 60))
          LEAD_TIME_HOURS=$(echo "scale=2; $LEAD_TIME / 3600" | bc)

          echo "=================================="
          echo "ðŸ“Š REAL LEAD TIME CALCULATION"
          echo "=================================="
          echo "â±ï¸  Commit Time: $COMMIT_TIME"
          echo "â±ï¸  Deploy End Time: $DEPLOY_TIME"
          echo "â±ï¸  Lead Time: $LEAD_TIME seconds"
          echo "â±ï¸  Lead Time: $LEAD_TIME_MINUTES minutes"
          echo "â±ï¸  Lead Time: $LEAD_TIME_HOURS hours"
          echo "=================================="

          curl -X POST ${{ secrets.APP_URL }}/api/metrics/leadtime \
            -H "Content-Type: application/json" \
            -H "X-API-Key: ${{ secrets.METRICS_API_KEY }}" \
            -d '{
              "tool": "github-actions",
              "commit": "${{ github.sha }}",
              "commit_time": "'"$COMMIT_TIME"'",
              "deploy_time": "'"$DEPLOY_TIME"'",
              "lead_time_seconds": '$LEAD_TIME'
            }' && echo "âœ… Real lead time recorded: ${LEAD_TIME}s (${LEAD_TIME_MINUTES}m)"

      # ============================================
      # MÃ‰TRICA DORA 3: CHANGE FAILURE RATE (Success)
      # ============================================
      - name: ðŸ“Š Record Deployment Success
        if: success()
        run: |
          curl -X POST ${{ secrets.APP_URL }}/api/metrics/deployment-result \
            -H "Content-Type: application/json" \
            -H "X-API-Key: ${{ secrets.METRICS_API_KEY }}" \
            -d '{
              "tool": "github-actions",
              "timestamp": "${{ steps.deploy_end.outputs.DEPLOY_END_TIME }}",
              "commit": "${{ github.sha }}",
              "status": "success",
              "is_failure": false
            }' && echo "âœ… Deployment success recorded"

      # ============================================
      # MÃ‰TRICA DORA 4: MEAN TIME TO RECOVERY (Auto-resolve)
      # ============================================
      - name: ðŸ“Š Auto-resolve Previous Incidents (MTTR)
        if: success()
        run: |
          RESPONSE=$(curl -s -X POST ${{ secrets.APP_URL }}/api/metrics/incident/resolve \
            -H "Content-Type: application/json" \
            -H "X-API-Key: ${{ secrets.METRICS_API_KEY }}" \
            -d '{
              "tool": "github-actions",
              "resolution_time": "${{ steps.deploy_end.outputs.DEPLOY_END_TIME }}"
            }')

          echo "$RESPONSE"

          if echo "$RESPONSE" | grep -q "resolved"; then
            echo "âœ… Previous incident resolved"
            echo "$RESPONSE" | grep -o '"mttr_minutes":[0-9.]*' || true
          else
            echo "â„¹ï¸  No open incidents to resolve"
          fi

      # ============================================
      # FAILURES: Record Failure & Create Incident
      # ============================================
      - name: ðŸ“Š Record Deployment Failure
        if: failure()
        run: |
          FAILURE_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)

          curl -X POST ${{ secrets.APP_URL }}/api/metrics/deployment-result \
            -H "Content-Type: application/json" \
            -H "X-API-Key: ${{ secrets.METRICS_API_KEY }}" \
            -d '{
              "tool": "github-actions",
              "timestamp": "'"$FAILURE_TIME"'",
              "commit": "${{ github.sha }}",
              "status": "failure",
              "is_failure": true
            }' && echo "âŒ Deployment failure recorded"

      - name: ðŸ“Š Create Incident (MTTR)
        if: failure()
        run: |
          INCIDENT_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)

          curl -X POST ${{ secrets.APP_URL }}/api/metrics/incident \
            -H "Content-Type: application/json" \
            -H "X-API-Key: ${{ secrets.METRICS_API_KEY }}" \
            -d '{
              "tool": "github-actions",
              "incident_id": "${{ github.run_id }}",
              "start_time": "'"$INCIDENT_TIME"'",
              "commit": "${{ github.sha }}",
              "status": "open",
              "description": "Deployment failed in GitHub Actions - Run ID: ${{ github.run_id }}"
            }' && echo "ðŸš¨ Incident created for failed deployment"

      # ============================================
      # RESUMEN FINAL CON MÃ‰TRICAS REALES
      # ============================================
      - name: ðŸ“Š DORA Metrics Summary
        if: always()
        run: |
          echo "=========================================="
          echo "ðŸ“Š DORA METRICS - DEPLOYMENT SUMMARY"
          echo "=========================================="
          echo "ðŸš€ Deployment Status: ${{ job.status }}"
          echo "ðŸ“ Commit: ${{ github.sha }}"
          echo "ðŸŒ¿ Branch: ${{ github.ref_name }}"
          echo ""
          echo "âœ… Metrics Recorded:"
          echo "  â€¢ Deployment Frequency âœ“"
          echo "  â€¢ Lead Time for Changes âœ“ (Real time from commit to deploy)"
          echo "  â€¢ Change Failure Rate âœ“"
          echo "  â€¢ Mean Time to Recovery âœ“"
          echo "=========================================="
          echo ""
          echo "ðŸ“ˆ View full DORA metrics:"
          echo "${{ secrets.APP_URL }}/api/metrics/dora?tool=github-actions&period=30"
          echo "=========================================="

      # ============================================
      # BONUS: Fetch and Display Current Metrics
      # ============================================
      - name: ðŸ“Š Display Current DORA Metrics
        if: always()
        continue-on-error: true
        run: |
          echo ""
          echo "ðŸ“Š Current DORA Performance (Last 30 days):"
          echo "=========================================="

          curl -s -X GET "${{ secrets.APP_URL }}/api/metrics/dora?tool=github-actions&period=30" \
            -H "X-API-Key: ${{ secrets.METRICS_API_KEY }}" | jq -r '
              "Deployment Frequency: \(.metrics.deployment_frequency.value) deploys/day [\(.metrics.deployment_frequency.rating)]",
              "Lead Time: \(.metrics.lead_time_for_changes.value_hours) hours [\(.metrics.lead_time_for_changes.rating)]",
              "Change Failure Rate: \(.metrics.change_failure_rate.value)% [\(.metrics.change_failure_rate.rating)]",
              "MTTR: \(.metrics.mean_time_to_recovery.value_hours) hours [\(.metrics.mean_time_to_recovery.rating)]",
              "",
              "Overall Rating: \(.overall_rating)"
            ' 2>/dev/null || echo "Could not fetch metrics (API might be unavailable)"

          echo "=========================================="
